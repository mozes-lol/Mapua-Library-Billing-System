<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapua Billing Library Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* =========================================
           GLOBAL RESET & VARIABLES
        ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Mapúa Color Palette */
            --primary-maroon: #4a0000;
            --dark-maroon: #350000;
            --accent-gold: #ffcc00;
            --cream: #fff8dc;

            /* Functional Colors */
            --green-success: #2e8b57;
            --red-danger: #d9534f;
            --light-red: #a53f3f;
            --form-red: #8b3a3a;
            --white: #ffffff;
            --off-white: #e0e0e0;
            --med-gray: #ccc;
            --dark-gray: #888;

            /* Status Colors */
            --status-processed: #5cb85c;
            --status-encoding: #f0ad4e;
            --status-waiting: #999;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-maroon);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .container { display: flex; width: 100%; height: 100%; }

        /* =========================================
           SIDEBAR STYLING - ENHANCED
        ========================================= */
        .sidebar {
            width: 280px;
            background-color: var(--dark-maroon);
            border-right: 3px solid var(--accent-gold);
            color: var(--white);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.4);
        }

        .logo-section {
            padding: 20px;
            background: linear-gradient(135deg, #600000 0%, #4a0000 100%);
            border-bottom: 2px solid rgba(255, 204, 0, 0.3);
            display: flex; align-items: center; gap: 15px;
        }

        .logo-placeholder {
            width: 70px; height: 70px;
            background-color: var(--white);
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        .logo-placeholder img { width: 90%; height: 90%; object-fit: contain; }

        .logo-section h3 {
            color: var(--white); font-size: 14px;
            line-height: 1.3; text-transform: uppercase;
            letter-spacing: 1.5px; font-weight: 600;
        }

        .menu-header {
            padding: 25px 25px 15px; font-size: 20px; font-weight: 700;
            letter-spacing: 2px; color: var(--white);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu { list-style: none; padding: 0; }
        .menu li {
            padding: 0;
            cursor: pointer;
            border-left: 4px solid transparent;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .menu li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, rgba(255, 204, 0, 0.2) 0%, transparent 100%);
            transition: width 0.3s ease;
        }

        .menu li:hover::before {
            width: 100%;
        }

        .menu li a {
            color: var(--white); text-decoration: none; font-weight: 600;
            font-size: 14px; display: flex; align-items: center; gap: 15px;
            padding: 18px 25px; text-transform: uppercase; letter-spacing: 1px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .menu li i {
            transition: transform 0.3s ease;
        }

        .menu li:hover {
            background-color: rgba(96, 0, 0, 0.5);
            border-left-color: var(--accent-gold);
            transform: translateX(3px);
        }

        .menu li:hover i {
            transform: translateX(5px);
        }

        .menu li:hover a {
            color: var(--accent-gold);
        }

        .menu li.active {
            background-color: #600000;
            border-left-color: var(--accent-gold);
            box-shadow: inset 0 0 20px rgba(255, 204, 0, 0.2);
        }
        .menu li.active a { color: var(--accent-gold); }

        .menu li.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 10px 10px 0;
            border-color: transparent var(--primary-maroon) transparent transparent;
        }

        /* =========================================
           MAIN CONTENT AREA
        ========================================= */
        .content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--primary-maroon); height: 100%; overflow: hidden; }

        .top-bar {
            background: linear-gradient(135deg, #350000 0%, #2a0000 100%);
            color: var(--white); padding: 18px 30px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--accent-gold); flex-shrink: 0;
        }

        .user-info { font-size: 15px; color: var(--off-white); font-weight: 500; }
        #current-user, #current-date { color: var(--accent-gold); font-weight: 700; }
        .separator { margin: 0 15px; color: var(--accent-gold); }

        .btn-logout {
            background-color: transparent; border: 2px solid var(--white);
            color: var(--white); padding: 8px 20px; border-radius: 20px;
            cursor: pointer; font-weight: 600; font-size: 12px;
            transition: all 0.3s ease;
        }
        .btn-logout:hover {
            background-color: var(--white);
            color: var(--primary-maroon);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 255, 255, 0.3);
        }

        /* =========================================
           DASHBOARD VIEW (QUEUE TAB)
        ========================================= */
        #dashboard-view { display: flex; flex-direction: column; height: 100%; }

        .summary-section { padding: 25px 30px 20px; flex-shrink: 0; }

        .section-label {
            color: var(--accent-gold);
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            background-color: rgba(255, 204, 0, 0.15);
            padding: 4px 12px;
            border-radius: 10px 10px 0 0;
            display: inline-block;
            letter-spacing: 0;
        }

        .cards-container {
            display: flex; gap: 20px; background-color: rgba(90, 0, 0, 0.6);
            padding: 20px; border-radius: 0 15px 15px 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            margin-top: 0;
        }

        .card {
            flex: 1; padding: 20px; border-radius: 15px; color: var(--white);
            text-align: center; display: flex; flex-direction: column;
            justify-content: center; gap: 8px; height: 100px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .maroon-card { background: linear-gradient(135deg, #350000 0%, #4a0000 100%); border: 2px solid var(--accent-gold); }
        .green-card { background: linear-gradient(135deg, #28a745 0%, #218838 100%); border: 2px solid var(--white); }

        .card-title { font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .card-value { font-size: 28px; font-weight: 800; }

        /* Queue Section */
        .queue-section { padding: 0 30px 25px; flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }

        .table-container {
            background-color: var(--white); border-radius: 0 15px 15px 15px;
            overflow-y: auto; flex-grow: 1; position: relative;
            background-image: repeating-linear-gradient(transparent, transparent 48px, var(--light-gray) 48px, var(--light-gray) 49px);
            background-attachment: local;
        }

        table { width: 100%; border-collapse: collapse; }
        thead { background-color: var(--cream); color: var(--primary-maroon); position: sticky; top: 0; z-index: 10; }
        th { padding: 15px 20px; text-align: left; font-size: 13px; border-bottom: 3px solid var(--primary-maroon); }
        td { padding: 12px 20px; height: 49px; vertical-align: middle; }

        .badge { padding: 5px 15px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #fff; }
        .badge.processed { background-color: var(--status-processed); }
        .badge.encoding { background-color: var(--status-encoding); }
        .badge.waiting { background-color: var(--status-waiting); }

        /* Action Buttons - ENHANCED */
        .action-buttons {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: -35px; padding: 0 25px; position: relative; z-index: 20;
        }

        .btn-new-form {
            width: 70px; height: 70px;
            background: linear-gradient(135deg, #fffacd 0%, #fff8b8 100%);
            border: 4px solid var(--white); border-radius: 50%; font-size: 28px;
            color: var(--primary-maroon); cursor: pointer;
            box-shadow: 0 6px 15px rgba(0,0,0,0.5), 0 0 0 0 rgba(255, 204, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-new-form::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-new-form:hover::before {
            width: 100px;
            height: 100px;
        }

        .btn-new-form:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.6), 0 0 0 10px rgba(255, 204, 0, 0.3);
            background: linear-gradient(135deg, #fff8b8 0%, var(--accent-gold) 100%);
        }

        .btn-new-form:active {
            transform: scale(1.05) rotate(90deg);
        }

        .btn-new-form i {
            position: relative;
            z-index: 1;
        }

        .btn-start-encoding {
            background: linear-gradient(135deg, var(--green-success) 0%, #246b43 100%);
            color: var(--white); border: 3px solid var(--white); padding: 14px 30px;
            border-radius: 30px; font-weight: 700; font-size: 13px; cursor: pointer;
            display: flex; gap: 12px; align-items: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-start-encoding::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-start-encoding:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-start-encoding:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.5);
            border-width: 4px;
        }

        .btn-start-encoding i {
            animation: spin 2s linear infinite;
            position: relative;
            z-index: 1;
        }

        .btn-start-encoding:hover i {
            animation: spin 0.5s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn-start-encoding span {
            position: relative;
            z-index: 1;
        }

        /* =========================================
           BILLING FORM VIEW - COMPLETELY REDESIGNED
        ========================================= */
        #form-view {
            padding: 20px 30px;
            flex-grow: 1;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .tab-label {
            background: linear-gradient(135deg, var(--form-red) 0%, #6d2d2d 100%);
            color: var(--white);
            padding: 12px 30px;
            border-radius: 10px 10px 0 0;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            letter-spacing: 1.5px;
        }

        .btn-back {
            background: linear-gradient(135deg, var(--red-danger) 0%, #c9302c 100%);
            color: var(--white);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.6);
        }

        .billing-container {
            background: linear-gradient(135deg, var(--light-red) 0%, #924040 100%);
            padding: 30px;
            border-radius: 0 15px 15px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .form-top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        .form-section h3 {
            color: var(--white);
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255, 204, 0, 0.3);
            padding-bottom: 10px;
        }

        .form-inputs-wrapper { display: flex; flex-direction: column; gap: 15px; }
        .input-group { display: flex; align-items: center; gap: 12px; }
        .input-group label {
            min-width: 90px;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .dark-input {
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--white);
            flex: 1;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .dark-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.2), inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .dark-input:disabled, .dark-input[readonly] {
            background-color: rgba(0,0,0,0.6);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-verify {
            background: linear-gradient(135deg, #4a8b5e 0%, #3d7a4f 100%);
            color: var(--white);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            text-transform: uppercase;
        }

        .btn-verify:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            background: linear-gradient(135deg, #3d7a4f 0%, #2e6b40 100%);
        }

        /* Transaction Meta */
        .transaction-meta { display: flex; gap: 15px; margin-bottom: 15px; }
        .meta-item { display: flex; align-items: center; gap: 8px; }
        .meta-label {
            color: var(--white);
            font-size: 11px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .meta-input {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            color: var(--white);
            width: 120px;
            text-align: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Bottom Row */
        .form-bottom-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; flex-grow: 1; }

        .service-label-wrapper { margin-bottom: 10px; }
        .service-type-label {
            color: var(--white);
            font-size: 11px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .checklist-box {
            background: linear-gradient(135deg, var(--cream) 0%, #fef5dc 100%);
            padding: 25px 30px;
            border-radius: 12px;
            border: 4px solid rgba(0, 0, 0, 0.5);
            color: var(--primary-maroon);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 8px;
            flex-grow: 1;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.5);
            overflow-y: auto;
            max-height: 400px;
        }

        .check-item {
            display: flex;
            align-items: center;
            font-weight: 700;
            padding: 8px 0;
            transition: all 0.2s ease;
            border-radius: 6px;
            padding-left: 5px;
        }

        .check-item:hover {
            background-color: rgba(255, 204, 0, 0.1);
            transform: translateX(5px);
        }

        .check-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--primary-maroon);
        }
        .check-item label { flex: 1; cursor: pointer; }

        .qty-input {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid var(--primary-maroon);
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            transition: all 0.3s ease;
            background-color: var(--white);
        }

        .qty-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.2);
            transform: scale(1.05);
        }

        .qty-input:disabled {
            background-color: #ddd;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Summary & Footer */
        .summary-content {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.5) 100%);
            border-radius: 12px;
            padding: 30px;
            color: var(--white);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3), inset 0 2px 10px rgba(0,0,0,0.3);
            border: 2px solid rgba(255, 204, 0, 0.2);
        }

        .sum-row {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 16px;
            padding: 5px 0;
        }

        .total-row {
            font-size: 24px;
            font-weight: 800;
            margin-top: 5px;
            border-top: 2px dashed rgba(255,255,255,0.5);
            padding-top: 15px;
            color: var(--accent-gold);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .form-footer {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            align-items: center;
        }

        .btn-cancel-red, .btn-delete-form, .btn-finalize {
            color: var(--white);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 16px 40px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn-cancel-red::before,
        .btn-delete-form::before,
        .btn-finalize::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-cancel-red:hover::before,
        .btn-delete-form:hover::before,
        .btn-finalize:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-cancel-red {
            background: linear-gradient(135deg, var(--red-danger) 0%, #c9302c 100%);
            box-shadow: 0 4px 12px rgba(217, 83, 79, 0.4);
        }

        .btn-delete-form {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-finalize {
            background: linear-gradient(135deg, #4a8b5e 0%, #3d7a4f 100%);
            box-shadow: 0 4px 12px rgba(74, 139, 94, 0.4);
        }

        .btn-cancel-red:hover,
        .btn-delete-form:hover,
        .btn-finalize:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.6);
        }

        .btn-cancel-red span,
        .btn-delete-form span,
        .btn-finalize span {
            position: relative;
            z-index: 1;
        }

        /* =========================================
           SUCCESS NOTICE MODAL
        ========================================= */
        .success-notice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .success-notice {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            width: 500px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid var(--accent-gold);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .success-notice-header {
            background: linear-gradient(135deg, var(--green-success) 0%, #246b43 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.2s backwards;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .success-icon i {
            font-size: 40px;
            color: var(--green-success);
        }

        .success-notice-header h2 {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .success-notice-body {
            padding: 35px 30px;
            color: var(--primary-maroon);
        }

        .success-message {
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
            font-weight: 500;
        }

        .transaction-details {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--accent-gold);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #ccc;
        }

        .detail-row:last-child {
            border-bottom: none;
            font-weight: 800;
            font-size: 18px;
            padding-top: 15px;
            margin-top: 5px;
            border-top: 2px solid var(--primary-maroon);
            color: var(--green-success);
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            font-weight: 700;
            color: var(--primary-maroon);
        }

        .email-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border: 2px solid var(--accent-gold);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .email-info i {
            font-size: 24px;
            color: var(--accent-gold);
            margin-bottom: 8px;
            display: block;
        }

        .email-info p {
            margin: 5px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .email-address {
            color: var(--primary-maroon);
            font-weight: 700;
            font-size: 15px;
        }

        .btn-close-success {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-maroon) 0%, var(--dark-maroon) 100%);
            color: white;
            border: 2px solid var(--accent-gold);
            padding: 15px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-close-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, var(--dark-maroon) 0%, #2a0000 100%);
        }

        /* =========================================
           SERVICES VIEW - ENHANCED
        ========================================= */
        #services-view, #reports-view {
            padding: 25px 30px;
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .services-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .services-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 0;
        }

        .btn-add-service-top {
            background: linear-gradient(135deg, #2e8b57 0%, #246b43 100%);
            color: white;
            border: 2px solid white;
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-add-service-top::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-add-service-top:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn-add-service-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .btn-add-service-top i,
        .btn-add-service-top span {
            position: relative;
            z-index: 1;
        }

        .services-container {
            background-color: var(--white);
            border-radius: 0 15px 15px 15px;
            flex-grow: 1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            padding: 20px;
            overflow-y: auto;
        }

        .services-table {
            width: 100%;
            border-collapse: collapse;
        }

        .services-table thead {
            background: linear-gradient(135deg, var(--primary-maroon) 0%, var(--dark-maroon) 100%);
            color: var(--accent-gold);
        }

        .services-table th {
            padding: 15px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .services-table th:nth-child(2),
        .services-table th:nth-child(3),
        .services-table th:nth-child(4) {
            text-align: center;
        }

        .services-table tbody tr {
            border-bottom: 1px solid #ddd;
            transition: all 0.3s ease;
        }

        .services-table tbody tr:hover {
            background-color: rgba(255, 204, 0, 0.1);
            transform: translateX(5px);
        }

        .services-table td {
            padding: 15px 20px;
            font-weight: 600;
            color: var(--primary-maroon);
        }

        .services-table td:nth-child(2),
        .services-table td:nth-child(3),
        .services-table td:nth-child(4) {
            text-align: center;
        }

        .status-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .status-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--green-success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .btn-edit-service {
            background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            font-size: 11px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-edit-service:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.3);
        }

        /* =========================================
           SERVICE MODALS - ADD/EDIT
        ========================================= */
        .service-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .service-modal {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            width: 500px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid var(--primary-maroon);
        }

        .service-modal-header {
            background: linear-gradient(135deg, var(--primary-maroon) 0%, var(--dark-maroon) 100%);
            color: var(--accent-gold);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-modal-header h2 {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: var(--white);
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .service-modal-body {
            padding: 30px;
        }

        .modal-form-group {
            margin-bottom: 20px;
        }

        .modal-form-group label {
            display: block;
            color: var(--primary-maroon);
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.2);
        }

        .modal-status-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .modal-status-group .status-toggle {
            margin: 0;
        }

        .status-label {
            font-weight: 700;
            color: var(--primary-maroon);
        }

        .status-label.active {
            color: var(--green-success);
        }

        .service-modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .btn-modal-save,
        .btn-modal-delete,
        .btn-modal-cancel-action {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-modal-save {
            background: linear-gradient(135deg, var(--green-success) 0%, #246b43 100%);
            color: white;
            flex: 1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-modal-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .btn-modal-delete {
            background: linear-gradient(135deg, var(--red-danger) 0%, #c9302c 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-modal-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .btn-modal-cancel-action {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-modal-cancel-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            background: #5a6268;
        }

        /* Delete Confirmation Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .custom-modal {
            background: var(--cream); width: 400px; border-radius: 15px;
            border: 4px solid var(--primary-maroon); overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header {
            background: var(--primary-maroon); color: var(--accent-gold);
            padding: 15px 20px; font-weight: 700; display: flex; justify-content: space-between;
        }
        .close-x { background: none; border: none; color: var(--white); font-size: 20px; cursor: pointer; }
        .modal-body { padding: 30px 20px; text-align: center; color: var(--primary-maroon); }
        .modal-footer {
            padding: 15px 20px; background: rgba(0,0,0,0.05); display: flex; justify-content: center; gap: 15px;
        }
        .btn-modal-yes { background: var(--red-danger); color: white; padding: 10px 30px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-modal-cancel { background: var(--med-gray); color: #333; padding: 10px 30px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

<div class="container">
    <nav class="sidebar">
        <div class="logo-section">
            <div class="logo-placeholder">
                <img src="../resources/mapua_logo.png" alt="Mapua Logo">
            </div>
            <h3>MAPUA BILLING<br>LIBRARY MGMT SYSTEM</h3>
        </div>
        <div class="menu-header">MENU</div>
        <ul class="menu">
            <li class="active" onclick="switchTab('queue')" id="nav-queue">
                <a href="#"><i class="fas fa-chevron-right"></i> QUEUE</a>
            </li>
            <li onclick="switchTab('reports')" id="nav-reports">
                <a href="#"><i class="fas fa-chevron-right"></i> REPORTS</a>
            </li>
            <li onclick="switchTab('services')" id="nav-services">
                <a href="#"><i class="fas fa-chevron-right"></i> SERVICES</a>
            </li>
        </ul>
    </nav>

    <main class="content">
        <header class="top-bar">
            <div class="user-info">
                <span>USER: <span id="current-user">LIBRARIAN_01</span></span>
                <span class="separator">|</span>
                <span>DATE: <span id="current-date">Loading...</span></span>
            </div>
            <button class="btn-logout">LOGOUT</button>
        </header>

        <div id="dashboard-view">
            <section class="summary-section">
                <div class="section-label">DAILY SUMMARY</div>
                <div class="cards-container">
                    <div class="card maroon-card">
                        <span class="card-title">TRANSACTIONS:</span>
                        <span class="card-value" id="transaction-count">0</span>
                    </div>
                    <div class="card green-card">
                        <span class="card-title">PENDING EMAIL:</span>
                        <span class="card-value" id="pending-email-count">0</span>
                    </div>
                    <div class="card maroon-card">
                        <span class="card-title">FINES:</span>
                        <span class="card-value" id="dashboard-total-fines">₱ 0.00</span>
                    </div>
                </div>
            </section>

            <section class="queue-section">
                <div class="section-label">WAITING QUEUE</div>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>STUDENT ID</th>
                            <th>NAME</th>
                            <th>TIME</th>
                            <th>STATUS</th>
                        </tr>
                        </thead>
                        <tbody id="queue-tbody"></tbody>
                    </table>
                </div>

                <div class="action-buttons">
                    <button class="btn-new-form" onclick="showForm()" title="Add New Transaction">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn-start-encoding" onclick="startEncoding()">
                        <i class="fas fa-sync-alt"></i>
                        <span>START ENCODING</span>
                    </button>
                </div>
            </section>
        </div>

        <div id="reports-view">
            <div class="services-layout">
                <div class="services-header">
                    <div class="section-label">REPORTS SECTION</div>
                </div>
                <div class="services-container" style="display: flex; justify-content: center; align-items: center; color: #888;">
                    <h2>[ REPORTS MODULE COMING SOON ]</h2>
                </div>
            </div>
        </div>

        <div id="services-view">
            <div class="services-layout">
                <div class="services-header">
                    <div class="section-label">CURRENT SERVICE CATALOG</div>
                    <button class="btn-add-service-top" onclick="openAddServiceModal()">
                        <i class="fas fa-plus"></i>
                        <span>ADD SERVICE</span>
                    </button>
                </div>
                <div class="services-container">
                    <table class="services-table">
                        <thead>
                        <tr>
                            <th>SERVICE NAME</th>
                            <th>PRICE</th>
                            <th>STATUS</th>
                            <th>ACTION</th>
                        </tr>
                        </thead>
                        <tbody id="services-tbody">
                        <!-- Services will be rendered here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="form-view">
            <div class="form-header-row">
                <div class="tab-label">BILLING FORM</div>
                <button class="btn-back" onclick="switchTab('queue')">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>

            <div class="billing-container">
                <div class="form-top-row">
                    <div class="form-section user-details-section">
                        <h3>User Details</h3>
                        <div class="form-inputs-wrapper">
                            <div class="input-group">
                                <label>ID:</label>
                                <input type="text" id="student-id" class="dark-input">
                                <button id="verify-btn" class="btn-verify" onclick="verifyStudent()">VERIFY</button>
                            </div>
                            <div class="input-group">
                                <label>NAME:</label>
                                <input type="text" id="student-name" class="dark-input full-width" readonly>
                            </div>
                            <div class="input-group">
                                <label>PROG.:</label>
                                <input type="text" id="student-program" class="dark-input full-width" readonly>
                            </div>
                            <div class="input-group">
                                <label>EMAIL:</label>
                                <input type="email" id="student-email" class="dark-input full-width">
                            </div>
                        </div>
                    </div>

                    <div class="form-section transaction-section">
                        <h3>Transaction Inputs</h3>
                        <div class="transaction-meta">
                            <div class="meta-item">
                                <span class="meta-label">DATE:</span>
                                <input type="text" class="meta-input" id="transaction-date" readonly>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">TIME:</span>
                                <input type="text" class="meta-input" id="transaction-time" readonly>
                            </div>
                        </div>
                        <div class="form-inputs-wrapper">
                            <div class="input-group">
                                <label>TRANS. CODE:</label>
                                <input type="text" id="trans-code" class="dark-input full-width" placeholder="Enter Code">
                            </div>
                            <div class="input-group">
                                <label>FINE:</label>
                                <input type="text" id="fine-amount" class="dark-input full-width" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-bottom-row">
                    <div class="service-section">
                        <div class="service-label-wrapper">
                            <span class="service-type-label">SERVICE TYPE:</span>
                        </div>
                        <div class="checklist-box" id="service-checklist">
                            <!-- Services will be rendered here dynamically -->
                        </div>
                    </div>

                    <div class="summary-section-form">
                        <div class="summary-header">SUMMARY</div>
                        <div class="summary-content">
                            <div class="sum-row"><span>SUBTOTAL:</span><span id="subtotal-display">₱ 0.00</span></div>
                            <div class="sum-row"><span>FINES:</span><span id="fines-display">₱ 0.00</span></div>
                            <div class="sum-row total-row"><span>TOTAL:</span><span id="total-display">₱ 0.00</span></div>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <button class="btn-cancel-red" onclick="switchTab('queue')"><span>CANCEL</span></button>
                    <button id="manual-delete-btn" class="btn-delete-form" onclick="deleteForm()"><span>DELETE FORM</span></button>
                    <button class="btn-finalize" onclick="finalizeForm()"><span>FINALIZE & SEND INVOICE</span></button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal-overlay" style="display: none;">
    <div class="custom-modal">
        <div class="modal-header">
            <span>REMOVE TRANSACTION</span>
            <button class="close-x" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <h2>Are you sure you want to Delete this form?</h2>
        </div>
        <div class="modal-footer">
            <button class="btn-modal-yes" onclick="confirmDelete()">YES</button>
            <button class="btn-modal-cancel" onclick="closeDeleteModal()">CANCEL</button>
        </div>
    </div>
</div>

<!-- Success Notice Modal -->
<div id="success-notice" class="success-notice-overlay" style="display: none;">
    <div class="success-notice">
        <div class="success-notice-header">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>Transaction Complete!</h2>
        </div>
        <div class="success-notice-body">
            <p class="success-message">Your transaction has been successfully processed.</p>

            <div class="transaction-details">
                <div class="detail-row">
                    <span class="detail-label">Reference No:</span>
                    <span class="detail-value" id="success-ref-no">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Transaction Code:</span>
                    <span class="detail-value" id="success-trans-code">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Amount:</span>
                    <span class="detail-value" id="success-total-amount">₱ 0.00</span>
                </div>
            </div>

            <div class="email-info">
                <i class="fas fa-envelope"></i>
                <p>Digital Invoice Queued for Delivery</p>
                <p class="email-address" id="success-email">-</p>
            </div>

            <button class="btn-close-success" onclick="closeSuccessNotice()">CLOSE</button>
        </div>
    </div>
</div>

<!-- Add/Edit Service Modal -->
<div id="service-modal" class="service-modal-overlay" style="display: none;">
    <div class="service-modal">
        <div class="service-modal-header">
            <h2 id="service-modal-title">ADD NEW SERVICE</h2>
            <button class="close-modal-btn" onclick="closeServiceModal()">&times;</button>
        </div>
        <div class="service-modal-body">
            <div class="modal-form-group">
                <label>Service Name</label>
                <input type="text" id="modal-service-name" class="modal-input" placeholder="Enter service name">
            </div>
            <div class="modal-form-group">
                <label>Price (₱)</label>
                <input type="number" id="modal-service-price" class="modal-input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="modal-form-group">
                <label>Status</label>
                <div class="modal-status-group">
                    <label class="status-toggle">
                        <input type="checkbox" id="modal-service-status" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="status-label active" id="modal-status-label">Active (Visible in Billing Form)</span>
                </div>
            </div>
        </div>
        <div class="service-modal-footer">
            <button class="btn-modal-delete" id="modal-delete-btn" onclick="deleteService()" style="display: none;">DELETE</button>
            <button class="btn-modal-cancel-action" onclick="closeServiceModal()">CANCEL</button>
            <button class="btn-modal-save" onclick="saveService()">SAVE</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    import { SUPABASE_CONFIG, EMAILJS_CONFIG } from '../config.js';

    const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
    if (window.emailjs && EMAILJS_CONFIG?.publicKey) {
        window.emailjs.init(EMAILJS_CONFIG.publicKey);
    }

    // In-memory caches for Supabase-backed data
    let servicesDatabase = [];
    let queueData = [];

    let currentStudent = null; // { transactionId, id, name, program, email, services, status }
    let formMode = 'manual';   // 'manual' | 'encoding'
    let totalTransactions = 0;
    let totalFinesAccumulated = 0;
    const usedTransactionCodes = new Set();

    document.addEventListener("DOMContentLoaded", async function() {
        const dateElement = document.getElementById('current-date');
        if (dateElement) dateElement.innerText = new Date().toLocaleDateString('en-CA');

        document.getElementById('fine-amount').addEventListener('input', calculateTotal);

        // Status toggle listener for service modal
        document.getElementById('modal-service-status').addEventListener('change', function() {
            const label = document.getElementById('modal-status-label');
            if (this.checked) {
                label.textContent = 'Active (Visible in Billing Form)';
                label.classList.add('active');
            } else {
                label.textContent = 'Inactive (Hidden from Billing Form)';
                label.classList.remove('active');
            }
        });

        await Promise.all([
            loadServicesFromSupabase(),
            loadQueueFromSupabase()
        ]);

        renderQueue();
        calculateTotal();
    });

    // ========== SUPABASE LOADERS ==========

    async function loadServicesFromSupabase() {
        try {
            const { data, error } = await supabase
                .from('service_type')
                .select('id, service_name, price, is_active')
                .order('id', { ascending: true });

            if (error) {
                console.error('Error loading services from Supabase:', error);
                return;
            }

            servicesDatabase = (data || []).map(row => ({
                id: row.id,
                name: row.service_name,
                price: row.price,
                active: row.is_active
            }));

            renderServicesTable();
            renderBillingFormServices();
        } catch (err) {
            console.error('Unexpected error loading services:', err);
        }
    }

    async function loadQueueFromSupabase() {
        try {
            const { data, error } = await supabase
                .from('transactions')
                .select('id, student_id, student_name, program, email, created_at, status, services')
                .in('status', ['waiting', 'encoding'])
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading queue from Supabase:', error);
                return;
            }

            queueData = (data || []).map(row => ({
                transactionId: row.id,
                id: row.student_id,
                name: row.student_name,
                program: row.program,
                email: row.email,
                time: row.created_at
                    ? new Date(row.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : '',
                status: row.status || 'waiting',
                services: row.services || {}
            }));
        } catch (err) {
            console.error('Unexpected error loading queue:', err);
        }
    }

    // ========== SERVICE MANAGEMENT FUNCTIONS ==========

    function renderServicesTable() {
        const tbody = document.getElementById('services-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        servicesDatabase.forEach(service => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${service.name}</td>
                <td>₱ ${Number(service.price || 0).toFixed(2)}</td>
                <td>
                    <label class="status-toggle">
                        <input type="checkbox" ${service.active ? 'checked' : ''}
                               onchange="toggleServiceStatus(${service.id})">
                        <span class="toggle-slider"></span>
                    </label>
                </td>
                <td>
                    <button class="btn-edit-service" onclick="openEditServiceModal(${service.id})">
                        <i class="fas fa-edit"></i> EDIT
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderBillingFormServices() {
        const container = document.getElementById('service-checklist');
        if (!container) return;
        container.innerHTML = '';

        const activeServices = servicesDatabase.filter(s => s.active);

        activeServices.forEach(service => {
            const checkItem = document.createElement('div');
            checkItem.className = 'check-item';
            checkItem.innerHTML = `
                <input type="checkbox" id="service${service.id}" onchange="toggleQty(${service.id})">
                <label for="service${service.id}">${service.name.toUpperCase()}</label>
                <input type="number" id="qty${service.id}" class="qty-input" min="0" value="0"
                       disabled onchange="calculateTotal()">
            `;
            container.appendChild(checkItem);
        });
    }

    async function toggleServiceStatus(serviceId) {
        const service = servicesDatabase.find(s => s.id === serviceId);
        if (!service) return;

        const newActive = !service.active;
        try {
            const { error } = await supabase
                .from('service_type')
                .update({ is_active: newActive })
                .eq('id', serviceId);

            if (error) {
                console.error('Error updating service status:', error);
                alert('Failed to update service status in database.');
                return;
            }

            service.active = newActive;
            renderBillingFormServices();
            calculateTotal();
        } catch (err) {
            console.error('Unexpected error updating service status:', err);
        }
    }

    function openAddServiceModal() {
        window.editingServiceId = null;
        document.getElementById('service-modal-title').textContent = 'ADD NEW SERVICE';
        document.getElementById('modal-service-name').value = '';
        document.getElementById('modal-service-price').value = '';
        document.getElementById('modal-service-status').checked = true;
        document.getElementById('modal-status-label').textContent = 'Active (Visible in Billing Form)';
        document.getElementById('modal-status-label').classList.add('active');
        document.getElementById('modal-delete-btn').style.display = 'none';
        document.getElementById('service-modal').style.display = 'flex';
    }

    function openEditServiceModal(serviceId) {
        window.editingServiceId = serviceId;
        const service = servicesDatabase.find(s => s.id === serviceId);

        if (service) {
            document.getElementById('service-modal-title').textContent = 'EDIT SERVICE';
            document.getElementById('modal-service-name').value = service.name;
            document.getElementById('modal-service-price').value = service.price;
            document.getElementById('modal-service-status').checked = service.active;

            const label = document.getElementById('modal-status-label');
            if (service.active) {
                label.textContent = 'Active (Visible in Billing Form)';
                label.classList.add('active');
            } else {
                label.textContent = 'Inactive (Hidden from Billing Form)';
                label.classList.remove('active');
            }

            document.getElementById('modal-delete-btn').style.display = 'block';
            document.getElementById('service-modal').style.display = 'flex';
        }
    }

    function closeServiceModal() {
        document.getElementById('service-modal').style.display = 'none';
        window.editingServiceId = null;
    }

    async function saveService() {
        const name = document.getElementById('modal-service-name').value.trim();
        const price = parseFloat(document.getElementById('modal-service-price').value);
        const active = document.getElementById('modal-service-status').checked;

        if (!name) {
            alert('Please enter a service name');
            return;
        }

        if (isNaN(price) || price < 0) {
            alert('Please enter a valid price');
            return;
        }

        try {
            if (window.editingServiceId) {
                // Edit existing service
                const { data, error } = await supabase
                    .from('service_type')
                    .update({
                        service_name: name,
                        price: price,
                        is_active: active
                    })
                    .eq('id', window.editingServiceId)
                    .select()
                    .single();

                if (error) {
                    console.error('Error updating service:', error);
                    alert('Failed to update service in database.');
                    return;
                }

                const service = servicesDatabase.find(s => s.id === window.editingServiceId);
                if (service && data) {
                    service.name = data.service_name;
                    service.price = data.price;
                    service.active = data.is_active;
                }
            } else {
                // Add new service
                const { data, error } = await supabase
                    .from('service_type')
                    .insert({
                        service_name: name,
                        price: price,
                        is_active: active
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Error inserting service:', error);
                    alert('Failed to save service to database.');
                    return;
                }

                servicesDatabase.push({
                    id: data.id,
                    name: data.service_name,
                    price: data.price,
                    active: data.is_active
                });
            }

            renderServicesTable();
            renderBillingFormServices();
            calculateTotal();
            closeServiceModal();
        } catch (err) {
            console.error('Unexpected error saving service:', err);
        }
    }

    async function deleteService() {
        if (!window.editingServiceId) return;

        if (!confirm('Are you sure you want to delete this service?')) return;

        try {
            const { error } = await supabase
                .from('service_type')
                .delete()
                .eq('id', window.editingServiceId);

            if (error) {
                console.error('Error deleting service:', error);
                alert('Failed to delete service from database.');
                return;
            }

            servicesDatabase = servicesDatabase.filter(s => s.id !== window.editingServiceId);
            renderServicesTable();
            renderBillingFormServices();
            calculateTotal();
            closeServiceModal();
        } catch (err) {
            console.error('Unexpected error deleting service:', err);
        }
    }

    // ========== TAB SWITCHING ==========

    function switchTab(tabName) {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('reports-view').style.display = 'none';
        document.getElementById('services-view').style.display = 'none';
        document.getElementById('form-view').style.display = 'none';

        document.getElementById('nav-queue').classList.remove('active');
        document.getElementById('nav-reports').classList.remove('active');
        document.getElementById('nav-services').classList.remove('active');

        if (tabName === 'queue') {
            document.getElementById('dashboard-view').style.display = 'flex';
            document.getElementById('nav-queue').classList.add('active');
            if (currentStudent && currentStudent.status === 'encoding') {
                currentStudent.status = 'waiting';
            }
            resetForm();
            renderQueue();
        } else if (tabName === 'reports') {
            document.getElementById('reports-view').style.display = 'flex';
            document.getElementById('nav-reports').classList.add('active');
        } else if (tabName === 'services') {
            document.getElementById('services-view').style.display = 'flex';
            document.getElementById('nav-services').classList.add('active');
            renderServicesTable();
        }
    }

    function renderQueue() {
        const tbody = document.getElementById('queue-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        queueData.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${student.id}</td><td>${student.name}</td><td>${student.time}</td>
                             <td><span class="badge ${student.status}">${student.status}</span></td>`;
            tbody.appendChild(row);
        });
    }

    function toggleQty(serviceId) {
        if (formMode === 'encoding') return;

        const checkbox = document.getElementById(`service${serviceId}`);
        const qtyInput = document.getElementById(`qty${serviceId}`);

        if (checkbox && qtyInput) {
            if (checkbox.checked) {
                qtyInput.disabled = false;
            } else {
                qtyInput.disabled = true;
                qtyInput.value = 0;
            }
            calculateTotal();
        }
    }

    function updateFormUI() {
        const verifyBtn = document.getElementById('verify-btn');
        const manualDeleteBtn = document.getElementById('manual-delete-btn');
        const studentIdInput = document.getElementById('student-id');
        const studentNameInput = document.getElementById('student-name');
        const studentProgInput = document.getElementById('student-program');
        const studentEmailInput = document.getElementById('student-email');

        const activeServices = servicesDatabase.filter(s => s.active);
        activeServices.forEach(service => {
            const checkbox = document.getElementById(`service${service.id}`);
            const qtyInput = document.getElementById(`qty${service.id}`);

            if (checkbox && qtyInput) {
                if (formMode === 'manual') {
                    checkbox.disabled = false;
                    qtyInput.disabled = !checkbox.checked;
                } else {
                    checkbox.disabled = true;
                    qtyInput.disabled = true;
                }
            }
        });

        if (formMode === 'manual') {
            verifyBtn.style.display = 'inline-block';
            manualDeleteBtn.style.display = 'none';
            studentIdInput.disabled = false;
            studentNameInput.readOnly = true;
            studentProgInput.readOnly = true;
            studentEmailInput.readOnly = false;
        } else {
            verifyBtn.style.display = 'none';
            manualDeleteBtn.style.display = 'inline-block';
            studentIdInput.disabled = true;
            studentNameInput.readOnly = true;
            studentProgInput.readOnly = true;
            studentEmailInput.readOnly = true;
        }
    }

    function showForm() {
        resetForm();
        formMode = 'manual';
        updateFormUI();
        showFormView();
    }

    async function startEncoding() {
        if (!queueData.length) {
            await loadQueueFromSupabase();
        }

        const waitingStudent = queueData.find(s => s.status === 'waiting');
        if (!waitingStudent) return alert('No students waiting in the queue!');

        formMode = 'encoding';
        currentStudent = waitingStudent;

        try {
            const { error } = await supabase
                .from('transactions')
                .update({ status: 'encoding' })
                .eq('id', waitingStudent.transactionId);

            if (error) {
                console.error('Error setting transaction to encoding:', error);
            } else {
                waitingStudent.status = 'encoding';
            }
        } catch (err) {
            console.error('Unexpected error starting encoding:', err);
        }

        renderQueue();

        document.getElementById('student-id').value = waitingStudent.id;
        document.getElementById('student-name').value = waitingStudent.name;
        document.getElementById('student-program').value = waitingStudent.program;
        document.getElementById('student-email').value = waitingStudent.email || '';

        populateServices(waitingStudent.services);
        updateFormUI();
        showFormView();
    }

    async function verifyStudent() {
        const studentId = document.getElementById('student-id').value.trim();
        if (!studentId) {
            alert('Please enter a Student ID.');
            return;
        }

        try {
            const { data, error } = await supabase
                .from('users')
                .select('user_id, given_name, middle_name, last_name, program, email_address')
                .eq('user_id', studentId)
                .maybeSingle();

            if (error) {
                console.error('Error verifying student:', error);
                alert('Failed to verify student from database.');
                return;
            }

            if (!data) {
                alert('Student ID not found in database!');
                document.getElementById('student-name').value = '';
                document.getElementById('student-program').value = '';
                document.getElementById('student-email').value = '';
                return;
            }

            const fullName = `${data.given_name} ${data.middle_name || ''} ${data.last_name}`.trim();
            document.getElementById('student-name').value = fullName;
            document.getElementById('student-program').value = data.program || '';
            document.getElementById('student-email').value = data.email_address || '';
        } catch (err) {
            console.error('Unexpected error verifying student:', err);
        }
    }

    function calculateTotal() {
        let subtotal = 0;

        servicesDatabase.forEach(service => {
            if (service.active) {
                const checkbox = document.getElementById(`service${service.id}`);
                const qtyInput = document.getElementById(`qty${service.id}`);

                if (checkbox && checkbox.checked && qtyInput) {
                    subtotal += (parseInt(qtyInput.value) || 0) * Number(service.price || 0);
                }
            }
        });

        const fines = parseFloat(document.getElementById('fine-amount').value) || 0;

        document.getElementById('subtotal-display').innerText = `₱ ${subtotal.toFixed(2)}`;
        document.getElementById('fines-display').innerText = `₱ ${fines.toFixed(2)}`;
        document.getElementById('total-display').innerText = `₱ ${(subtotal + fines).toFixed(2)}`;
    }

    function deleteForm() {
        document.getElementById('delete-modal').style.display = 'flex';
    }

    async function confirmDelete() {
        if (formMode === 'encoding' && currentStudent) {
            try {
                const { error } = await supabase
                    .from('transactions')
                    .update({ status: 'cancelled' })
                    .eq('id', currentStudent.transactionId);

                if (error) {
                    console.error('Error cancelling transaction:', error);
                    alert('Failed to cancel transaction in database.');
                } else {
                    queueData = queueData.filter(student => student.transactionId !== currentStudent.transactionId);
                    currentStudent = null;
                    renderQueue();
                }
            } catch (err) {
                console.error('Unexpected error cancelling transaction:', err);
            }
        }
        closeDeleteModal();
        switchTab('queue');
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
    }

    function getSelectedServices() {
        const selected = {};
        servicesDatabase.forEach(service => {
            if (service.active) {
                const checkbox = document.getElementById(`service${service.id}`);
                const qtyInput = document.getElementById(`qty${service.id}`);
                const qty = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
                if (checkbox && checkbox.checked && qty > 0) {
                    selected[service.id] = qty;
                }
            }
        });
        return selected;
    }

    async function finalizeForm() {
        const tCode = document.getElementById('trans-code').value.trim();
        const totalDisplay = document.getElementById('total-display').innerText;
        const email = document.getElementById('student-email').value.trim();
        const fineInput = parseFloat(document.getElementById('fine-amount').value) || 0;

        const studentName = document.getElementById('student-name').value.trim();
        const studentId = document.getElementById('student-id').value.trim();
        const program = document.getElementById('student-program').value.trim();

        if (!studentName) return alert('Student details missing!');
        if (!tCode) return alert('Please enter a Transaction Code!');
        if (!email) return alert('Student Email is missing!');

        if (usedTransactionCodes.has(tCode)) {
            return alert('ERROR: This Transaction Code has already been used. Please enter a unique code.');
        }

        // Recompute numeric subtotal/total
        let subtotal = 0;
        const selectedServices = getSelectedServices();
        servicesDatabase.forEach(service => {
            if (selectedServices[service.id]) {
                subtotal += selectedServices[service.id] * Number(service.price || 0);
            }
        });
        const totalNumeric = subtotal + fineInput;

        const refNo = "REF-" + Math.floor(Math.random() * 1000000);

        try {
            if (currentStudent && formMode === 'encoding') {
                // Update existing queued transaction
                const { error } = await supabase
                    .from('transactions')
                    .update({
                        transaction_code: tCode,
                        reference_no: refNo,
                        services: selectedServices,
                        subtotal: subtotal,
                        fines: fineInput,
                        total_amount: totalNumeric,
                        status: 'approved'
                    })
                    .eq('id', currentStudent.transactionId);

                if (error) {
                    console.error('Error finalizing existing transaction:', error);
                    alert('Failed to finalize transaction in database.');
                    return;
                }

                currentStudent.status = 'processed';
            } else {
                // Walk-in / manual transaction: create new row
                const { error } = await supabase
                    .from('transactions')
                    .insert({
                        student_id: studentId,
                        student_name: studentName,
                        program: program,
                        email: email,
                        services: selectedServices,
                        subtotal: subtotal,
                        fines: fineInput,
                        total_amount: totalNumeric,
                        transaction_code: tCode,
                        reference_no: refNo,
                        status: 'approved'
                    });

                if (error) {
                    console.error('Error inserting new transaction:', error);
                    alert('Failed to save transaction to database.');
                    return;
                }
            }

            usedTransactionCodes.add(tCode);

            totalTransactions++;
            document.getElementById('transaction-count').innerText = totalTransactions;
            document.getElementById('pending-email-count').innerText = '0';

            totalFinesAccumulated += fineInput;
            document.getElementById('dashboard-total-fines').innerText = `₱ ${totalFinesAccumulated.toFixed(2)}`;

            // Send invoice via EmailJS
            if (window.emailjs && EMAILJS_CONFIG?.serviceId && EMAILJS_CONFIG?.templateId) {
                const servicesSummary = Object.entries(selectedServices)
                    .map(([id, qty]) => {
                        const svc = servicesDatabase.find(s => s.id === Number(id));
                        return svc ? `${svc.name} x${qty}` : `Service ${id} x${qty}`;
                    })
                    .join(', ');

                try {
                    await window.emailjs.send(
                        EMAILJS_CONFIG.serviceId,
                        EMAILJS_CONFIG.templateId,
                        {
                            to_email: email,
                            to_name: studentName,
                            student_id: studentId,
                            transaction_code: tCode,
                            reference_no: refNo,
                            total_amount: totalNumeric.toFixed(2),
                            fine_amount: fineInput.toFixed(2),
                            subtotal_amount: subtotal.toFixed(2),
                            services_summary: servicesSummary,
                            transaction_date: document.getElementById('transaction-date').value,
                            transaction_time: document.getElementById('transaction-time').value
                        }
                    );
                } catch (emailErr) {
                    console.error('Error sending invoice email:', emailErr);
                    // We don't block UI on email failure; just log it.
                }
            }

            // Show success modal with live data
            document.getElementById('success-ref-no').innerText = refNo;
            document.getElementById('success-trans-code').innerText = tCode;
            document.getElementById('success-total-amount').innerText = `₱ ${totalNumeric.toFixed(2)}`;
            document.getElementById('success-email').innerText = email;
            document.getElementById('success-notice').style.display = 'flex';

            await loadQueueFromSupabase();
            renderQueue();
        } catch (err) {
            console.error('Unexpected error finalizing transaction:', err);
        }
    }

    function closeSuccessNotice() {
        document.getElementById('success-notice').style.display = 'none';
        switchTab('queue');
    }

    function populateServices(services) {
        servicesDatabase.forEach(service => {
            if (service.active) {
                const checkbox = document.getElementById(`service${service.id}`);
                const qtyInput = document.getElementById(`qty${service.id}`);

                if (checkbox && qtyInput) {
                    if (services && services[service.id]) {
                        checkbox.checked = true;
                        qtyInput.value = services[service.id];
                        qtyInput.disabled = false;
                    } else {
                        checkbox.checked = false;
                        qtyInput.value = 0;
                        qtyInput.disabled = true;
                    }
                }
            }
        });
        calculateTotal();
    }

    function resetForm() {
        document.getElementById('student-id').value = '';
        document.getElementById('student-name').value = '';
        document.getElementById('student-program').value = '';
        document.getElementById('student-email').value = '';
        document.getElementById('trans-code').value = '';
        document.getElementById('fine-amount').value = '0';

        servicesDatabase.forEach(service => {
            if (service.active) {
                const checkbox = document.getElementById(`service${service.id}`);
                const qtyInput = document.getElementById(`qty${service.id}`);

                if (checkbox && qtyInput) {
                    checkbox.checked = false;
                    qtyInput.value = 0;
                    qtyInput.disabled = true;
                }
            }
        });

        currentStudent = null;
        calculateTotal();
    }

    function showFormView() {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('reports-view').style.display = 'none';
        document.getElementById('services-view').style.display = 'none';

        document.getElementById('form-view').style.display = 'flex';
        const now = new Date();
        document.getElementById('transaction-date').value = now.toLocaleDateString('en-CA');
        document.getElementById('transaction-time').value = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
</script>

</body>
</html>